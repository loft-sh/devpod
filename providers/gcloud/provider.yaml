name: gcloud
version: 0.0.1
description: |-
  DevPod on Google Cloud
options:
  GCLOUD_BINARY:
    description: Path to the gcloud binary
    default: gcloud
    before: init
  PROJECT:
    description: The project id to use.
    required: true
    command: ${GCLOUD_BINARY} config list --quiet --verbosity=error --format "value(core.project)"
  ZONE:
    description: The google cloud zone to create the VM in. E.g. europe-west1-d
    required: true
    command: ${GCLOUD_BINARY} config list --quiet --verbosity=error --format "value(compute.zone)"
  DISK_SIZE:
    description: The disk size to use.
    default: "30"
  DISK_IMAGE:
    description: The disk image to use.
    default: projects/cos-cloud/global/images/cos-101-17162-40-56
  MACHINE_TYPE:
    description: The machine type to use.
    default: e2-standard-2
  DELETE_ON_INACTIVITY:
    description: If the compute instance should get deleted instead of stopped on inactivity.
    default: "false"
    enum: ["false", "true"]
  GCLOUD_TOKEN:
    hidden: true
    cache: 30m
    before: command
    command: ${GCLOUD_BINARY} auth application-default print-access-token --quiet --verbosity=error
agent:
  path: /run/agent
  inactivityTimeout: 2m
  exec:
    shutdown: |-
      if [ "${DELETE_ON_INACTIVITY}" = "true" ]; then
        ${DEVPOD} helper http request -X DELETE \
                                    -H "Authorization: Bearer ${GCLOUD_TOKEN}" \
                                    https://compute.googleapis.com/compute/v1/projects/${PROJECT}/zones/${ZONE}/instances/devpod-${WORKSPACE_ID}
      else 
        ${DEVPOD} helper http request -X POST \
                                    -H "Authorization: Bearer ${GCLOUD_TOKEN}" \
                                    https://compute.googleapis.com/compute/v1/projects/${PROJECT}/zones/${ZONE}/instances/devpod-${WORKSPACE_ID}/stop
      fi
exec:
  init: |-
    if ! command -v ${GCLOUD_BINARY} &> /dev/null; then
        echo "${GCLOUD_BINARY} command couldn't be found. Please make sure to install the gcloud CLI locally"
        echo "Take a look at https://cloud.google.com/sdk/docs/install-sdk for more information"
        exit 1
    fi
  command: ${DEVPOD} provider call gcloud command
  create: ${DEVPOD} provider call gcloud create
  delete: ${DEVPOD} provider call gcloud delete
  start: ${DEVPOD} provider call gcloud start
  stop: ${DEVPOD} provider call gcloud stop
  status: ${DEVPOD} provider call gcloud status